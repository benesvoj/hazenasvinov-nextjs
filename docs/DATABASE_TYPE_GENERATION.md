# Database Type Generation

**Automatically generate TypeScript types from your Supabase database schema**

---

## Overview

This system automatically generates TypeScript type definitions from your Supabase database schema, ensuring that your types are always in sync with your actual database structure.

### **What It Does**

1. ✅ Generates types directly from database schema
2. ✅ Creates entity-specific schema files
3. ✅ Provides Insert/Update helper types
4. ✅ Keeps types in sync with migrations
5. ✅ Prevents type-database mismatches

---

## Quick Start

### **1. Initial Setup**

```bash
# Install Supabase CLI (if not already installed)
npm install -g supabase
```

### **2. Configure Environment Variables**

Copy the example file and add your credentials:

```bash
# Copy the example file
cp .env.local.example .env.local
```

Edit `.env.local` and add your Supabase credentials:

```bash
# Get your access token from: https://app.supabase.com/account/tokens
SUPABASE_ACCESS_TOKEN=sbp_your_access_token_here

# Get your project ref from: https://app.supabase.com/project/YOUR_PROJECT/settings/general
SUPABASE_PROJECT_REF=your-project-ref-here
```

**Where to find these values:**
- **Access Token**: https://app.supabase.com/account/tokens (create a new token)
- **Project Ref**: https://app.supabase.com/project/YOUR_PROJECT/settings/general (Reference ID)

### **2. Generate Types**

```bash
# Generate types from database
npm run db:generate-types
```

This will:
1. Connect to your Supabase database
2. Generate `src/types/database/supabase.ts` with all table types
3. Split types into entity-specific schema files
4. Create Insert/Update helper types

---

## Usage

### **Generated Files**

After running `npm run db:generate-types`, you'll get:

```
src/types/
├── database/
│   └── supabase.ts                    # Raw Supabase types (all tables)
└── entities/
    ├── member/
    │   └── schema/
    │       ├── membersSchema.ts        # ✨ Auto-generated
    │       └── memberClubRelationshipSchema.ts
    ├── category/
    │   └── schema/
    │       └── categoriesSchema.ts     # ✨ Auto-generated
    ├── club/
    │   └── schema/
    │       └── clubsSchema.ts          # ✨ Auto-generated
    └── ...
```

### **Example: Generated Schema**

**Input** (database table):
```sql
CREATE TABLE members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  registration_number VARCHAR(50),
  name VARCHAR(100) NOT NULL,
  surname VARCHAR(100) NOT NULL,
  date_of_birth DATE,
  sex VARCHAR(10) NOT NULL,
  category_id UUID REFERENCES categories(id),
  functions TEXT[],
  is_active BOOLEAN NOT NULL DEFAULT TRUE,
  is_external BOOLEAN NOT NULL DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Output** (`src/types/entities/member/schema/membersSchema.ts`):
```typescript
/**
 * Database schema for `members` table
 *
 * ⚠️ AUTO-GENERATED - DO NOT EDIT MANUALLY
 * Generated by: scripts/split-db-types.js
 * Source: src/types/database/supabase.ts
 *
 * Last generated: 2025-10-17
 */

export interface MemberSchema {
  id: string;
  registration_number: string | null;
  name: string;
  surname: string;
  date_of_birth: string | null;
  sex: string;
  category_id: string | null;
  functions: string[] | null;
  is_active: boolean;
  is_external: boolean;
  created_at: string;
  updated_at: string;
}

/**
 * Type for INSERT operations (auto-generated fields excluded)
 */
export type MemberInsert = Omit<
  MemberSchema,
  'id' | 'created_at' | 'updated_at'
> & {
  id?: string; // Optional for inserts
};

/**
 * Type for UPDATE operations (all fields optional except ID)
 */
export type MemberUpdate = {
  id: string;
} & Partial<Omit<MemberSchema, 'id' | 'created_at' | 'updated_at'>>;
```

---

## Workflow

### **After Database Migrations**

Whenever you create or update database tables:

```bash
# 1. Run your migration
psql -f scripts/migrations/20251017_add_is_active_to_members.sql

# 2. Regenerate types
npm run db:generate-types

# 3. Verify changes
git diff src/types/
```

### **Recommended Git Workflow**

```bash
# Commit migrations and types together
git add scripts/migrations/*.sql
git add src/types/entities/*/schema/*.ts
git commit -m "feat: add is_active column to members

- Migration: 20251017_add_is_active_to_members.sql
- Regenerated types to match database schema"
```

---

## Configuration

### **Adding New Entities**

To generate schema files for a new table, update `scripts/split-db-types.js`:

```javascript
const ENTITY_CONFIG = {
  // Existing entities...
  members: {
    folder: 'member',
    schemaName: 'MemberSchema',
  },

  // Add your new entity
  your_new_table: {
    folder: 'yourEntity',          // Folder under src/types/entities/
    schemaName: 'YourEntitySchema', // Generated interface name
  },
};
```

Then run:
```bash
npm run db:generate-schemas
```

---

## Using Generated Schemas

### **Pattern 1: Extend Schema in Domain Type**

```typescript
// src/types/entities/member/data/member.ts
import {MemberSchema} from '../schema/membersSchema';
import {Genders, MemberFunction} from '@/enums';

/**
 * Application-level Member type
 * Extends database schema with type-safe enums
 */
export interface Member extends Omit<MemberSchema, 'sex' | 'functions'> {
  sex: Genders;                  // Type-safe enum instead of string
  functions: MemberFunction[];   // Type-safe enum array
}
```

### **Pattern 2: Use Insert/Update Types**

```typescript
// In your hook or API route
import {MemberInsert, MemberUpdate} from '@/types/entities/member/schema/membersSchema';

export async function createMember(data: MemberInsert) {
  const {data: member, error} = await supabase
    .from('members')
    .insert(data)  // ✅ Type-safe!
    .select()
    .single();

  return member;
}

export async function updateMember(data: MemberUpdate) {
  const {data: member, error} = await supabase
    .from('members')
    .update(data)  // ✅ Type-safe!
    .eq('id', data.id)
    .select()
    .single();

  return member;
}
```

### **Pattern 3: Mapper Functions**

```typescript
// src/types/entities/member/mappers/toMember.ts
import {MemberSchema} from '../schema/membersSchema';
import {Member} from '../data/member';
import {Genders, MemberFunction} from '@/enums';

/**
 * Convert database row to application-level Member
 */
export function toMember(row: MemberSchema): Member {
  return {
    ...row,
    sex: row.sex === 'male' ? Genders.MALE : Genders.FEMALE,
    functions: (row.functions || []) as MemberFunction[],
  };
}
```

---

## Benefits

### **✅ Type Safety**
- Compile-time errors if database schema changes
- IDE autocomplete for all database fields
- No more runtime errors from typos

### **✅ Single Source of Truth**
- Database is the source of truth
- Types are generated, not manually maintained
- No type-database drift

### **✅ Documentation**
- Self-documenting: types show what's actually in database
- Generated comments include table names and generation dates
- Easy to see what's real vs. planned

### **✅ Refactoring Safety**
- Rename column in database → TypeScript errors guide you to update all usages
- Add/remove columns → Types update automatically
- Migrations and types stay in sync

---

## Troubleshooting

### **Error: "Supabase CLI not installed"**

```bash
npm install -g supabase
```

### **Error: "Supabase project not linked"**

```bash
supabase link --project-ref YOUR_PROJECT_REF
```

### **Error: "Table not found in database"**

The table doesn't exist in your database yet. Options:
1. Run the migration first
2. Remove the table from `ENTITY_CONFIG` in `scripts/split-db-types.js`

### **Generated types don't match database**

```bash
# Regenerate types
npm run db:generate-types

# If still issues, check Supabase connection
supabase db pull
```

---

## Best Practices

### **✅ DO**
- ✅ Run `npm run db:generate-types` after every migration
- ✅ Commit generated schema files with migrations
- ✅ Use schema types as base, extend for application logic
- ✅ Create mapper functions for type conversions
- ✅ Document which fields are computed vs. database fields

### **❌ DON'T**
- ❌ Manually edit generated schema files (they'll be overwritten)
- ❌ Add computed fields to schema types (use separate types)
- ❌ Commit migrations without regenerating types
- ❌ Skip type generation to "save time" (costs more later)

---

## Alternative: Manual Updates

If you can't use Supabase CLI, you can manually update schema files:

1. **Check database schema**:
   ```sql
   \d members  -- In psql
   ```

2. **Update schema file**:
   ```typescript
   // src/types/entities/member/schema/membersSchema.ts
   export interface MemberSchema {
     // Update to match database...
   }
   ```

3. **Add comment**:
   ```typescript
   /**
    * Last manually synced: 2025-10-17
    * Verified against database with: \d members
    */
   ```

---

## Examples

### **Example 1: Adding a Column**

```bash
# 1. Add column in migration
ALTER TABLE members ADD COLUMN is_active BOOLEAN DEFAULT TRUE;

# 2. Regenerate types
npm run db:generate-types

# 3. TypeScript now knows about is_active!
const member: Member = await getMember(id);
console.log(member.is_active);  // ✅ Type-safe!
```

### **Example 2: Renaming a Column**

```bash
# 1. Rename in migration
ALTER TABLE members RENAME COLUMN date_of_birth TO birth_date;

# 2. Regenerate types
npm run db:generate-types

# 3. TypeScript errors guide you to updates needed
const member: Member = await getMember(id);
console.log(member.date_of_birth);  // ❌ Error: Property doesn't exist
console.log(member.birth_date);     // ✅ Correct!
```

---

## Advanced: CI/CD Integration

### **GitHub Actions**

```yaml
# .github/workflows/type-check.yml
name: Type Check

on: [pull_request]

jobs:
  type-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Generate types
        run: npm run db:generate-types
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

      - name: Check for changes
        run: |
          if git diff --exit-code src/types/; then
            echo "✅ Types are in sync"
          else
            echo "❌ Types are out of sync - run npm run db:generate-types"
            exit 1
          fi

      - name: Type check
        run: npm run tsc
```

---

## FAQ

**Q: Do I need to commit generated files?**
A: Yes! Generated schema files should be committed so other developers and CI/CD have access to types without needing database access.

**Q: What if my database has fields not in the types?**
A: Regenerate types with `npm run db:generate-types`. If fields are still missing, they might be in a different schema or the script configuration needs updating.

**Q: Can I customize generated types?**
A: Don't edit generated files directly. Instead, create separate domain types that extend the schema types.

**Q: How often should I regenerate?**
A: After every database migration. Consider adding it to your migration script or CI/CD pipeline.

---

## Related Documentation

- [Database Migration Guide](./DATABASE_MIGRATIONS.md)
- [Member Type Architecture](./refactoring/MEMBERS_EXISTING_ANALYSIS.md)
- [Refactoring Plan](./refactoring/MEMBERS_LIST_TAB_REFACTORING_PLAN.md)

---

**Last Updated**: 2025-10-17
**Maintained By**: Development Team